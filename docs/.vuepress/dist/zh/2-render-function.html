<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VNode | Vue 设计之道</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Vue Design">
    
    <link rel="preload" href="/vue-design/assets/css/0.styles.21077327.css" as="style"><link rel="preload" href="/vue-design/assets/js/app.b406f0e2.js" as="script"><link rel="preload" href="/vue-design/assets/js/2.19e19e46.js" as="script"><link rel="preload" href="/vue-design/assets/js/3.77b9243c.js" as="script"><link rel="prefetch" href="/vue-design/assets/js/10.54998457.js"><link rel="prefetch" href="/vue-design/assets/js/11.41c83f08.js"><link rel="prefetch" href="/vue-design/assets/js/12.55a9024f.js"><link rel="prefetch" href="/vue-design/assets/js/13.5f80957d.js"><link rel="prefetch" href="/vue-design/assets/js/14.b7112601.js"><link rel="prefetch" href="/vue-design/assets/js/15.a5de1a6a.js"><link rel="prefetch" href="/vue-design/assets/js/4.06629a88.js"><link rel="prefetch" href="/vue-design/assets/js/5.236cecbe.js"><link rel="prefetch" href="/vue-design/assets/js/6.cf5d34a9.js"><link rel="prefetch" href="/vue-design/assets/js/7.506909a2.js"><link rel="prefetch" href="/vue-design/assets/js/8.1debe389.js"><link rel="prefetch" href="/vue-design/assets/js/9.519c1411.js">
    <link rel="stylesheet" href="/vue-design/assets/css/0.styles.21077327.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-design/" class="home-link router-link-active"><!----> <span class="site-name">Vue 设计之道</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-design/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-design/" class="nav-link">
  Chinese
</a></li></ul></div></div> <a href="https://github.com/yangzheli/vue-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-design/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-design/" class="nav-link">
  Chinese
</a></li></ul></div></div> <a href="https://github.com/yangzheli/vue-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/vue-design/zh/1-reactivity.html" class="sidebar-link">响应性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/1-reactivity.html#响应性原理" class="sidebar-link">响应性原理</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/1-reactivity.html#getter-setter" class="sidebar-link">getter/setter</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/1-reactivity.html#proxy" class="sidebar-link">Proxy</a></li></ul></li><li><a href="/vue-design/zh/2-render-function.html" aria-current="page" class="active sidebar-link">渲染函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#vnode" class="sidebar-link">VNode</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#挂载-mount" class="sidebar-link">挂载 mount</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#更新-patch" class="sidebar-link">更新 patch</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#diff-算法核心" class="sidebar-link">diff 算法核心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#最大索引值比较" class="sidebar-link">最大索引值比较</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#双端比较" class="sidebar-link">双端比较</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-design/zh/2-render-function.html#dom-api-封装" class="sidebar-link">DOM API 封装</a></li></ul></li><li><a href="/vue-design/zh/3-mini-vue.html" class="sidebar-link">迷你 Vue 实现</a></li><li><a href="/vue-design/zh/4-template-compile.html" class="sidebar-link">模板编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/4-template-compile.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/4-template-compile.html#抽象语法树-ast" class="sidebar-link">抽象语法树 AST</a></li><li class="sidebar-sub-header"><a href="/vue-design/zh/4-template-compile.html#返回渲染函数" class="sidebar-link">返回渲染函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/4-template-compile.html#v-bind" class="sidebar-link">v-bind</a></li></ul></li></ul></li><li><a href="/vue-design/zh/5-mini-vue.html" class="sidebar-link">迷你 Vue 改进</a></li><li><a href="/vue-design/zh/6-component.html" class="sidebar-link">组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/6-component.html#组件定义" class="sidebar-link">组件定义</a></li></ul></li><li><a href="/vue-design/zh/7-optimize.html" class="sidebar-link">优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/zh/7-optimize.html#静态根节点标记" class="sidebar-link">静态根节点标记</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="vnode"><a href="#vnode" class="header-anchor">#</a> VNode</h2> <p>在 <code>Vue</code> 中，我们可以使用<strong>模板语法</strong>来创建 <code>HTML</code>，也可以使用<strong>渲染函数</strong> <code>render</code> 来实现。</p> <p>比如下面我们通过 <code>render</code> 来创建 <code>div</code> 元素，并向它添加点击事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> h<span class="token punctuation">,</span> createApp <span class="token punctuation">}</span> <span class="token operator">=</span> Vue

<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">onclick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/rNzKwPq" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>上一节我们实现了响应式，那么如何通过渲染函数生成 <code>DOM</code> 元素，将其挂载到指定位置，并在元素内容改变对其更新呢？</p> <ul><li><p>首先我们需要实现 <code>h</code> 函数，它返回的是一个虚拟节点 <code>VNode</code> (Virtual Node)；</p></li> <li><p>其次需要实现 <code>mount</code> 函数，它将 <code>VNode</code> 挂载到指定容器 <code>container</code>；</p></li> <li><p>再者实现 <code>patch</code> 函数，根据新旧 <code>VNode</code> 对 <code>container</code> 更新。</p></li></ul> <p>首先，我们需要考虑：为什么先创建 <code>VNode</code>，通过 <code>VNode</code> 来更新真实 <code>DOM</code>?</p> <p>主要是因为除了浏览器端，我们还可能将元素渲染到其它平台，因此最终操作的不一定是 <code>DOM</code> 元素，比如 <code>Vue2</code> 提供了 <code>Weex</code> 相关的包，供开发者基于 <code>Weex</code> 来开发应用。因此，我们通过使用 <code>VNode</code> 来达到将渲染函数 <code>render</code> 与 <code>DOM</code> 之间<strong>接耦</strong>的目的，让渲染函数 <code>render</code> 不仅能渲染 <code>DOM</code> 元素，还能渲染其它平台的元素。我们将不同平台的编程接口进行封装，在需要时对这些接口进行替换，或者直接在初始化时将其作为参数传递，最终达到<strong>跨平台</strong>开发的目的。在之后的小节，我们将详细地对编程接口进行封装，而默认情况下，本文中渲染的都是 <code>DOM</code> 元素，即使用的是浏览器提供的 <code>DOM</code> 编程接口。</p> <p>解释完 <code>VNode</code> 的作用，下面就让我们先来定义 <code>VNode</code> 的结构。</p> <ul><li><p><code>tag</code> 属性：当前 <code>VNode</code> 创建的 <code>DOM</code> 元素的 <code>HTML</code> 标签名；</p></li> <li><p><code>props</code> 属性：创建元素的 <code>attribute</code> (包括事件)；</p></li> <li><p><code>children</code> 属性：创建元素的子节点，为简化逻辑，我们规定 <code>children</code> 只能为字符串、数组或者 <code>null</code>，<code>null</code> 我们当为空数组处理，数组中元素类型可以为 <code>VNode</code> 或者字符串。</p></li></ul> <p>因此，<code>h</code> 函数的实现就非常简单，返回一个包含节点信息的对象，只有当 <code>children</code> 为数组且子元素为字符串时需特殊处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">)</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> tag<span class="token operator">:</span> tag<span class="token punctuation">,</span> props<span class="token operator">:</span> props<span class="token punctuation">,</span> children<span class="token operator">:</span> children <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样，我们就可以用下面的 <code>VNode</code> 表示一个包含子节点的 <code>div</code> 元素。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><p>或者 (两者是等价的)：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'hello world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="挂载-mount"><a href="#挂载-mount" class="header-anchor">#</a> 挂载 mount</h2> <p>创建完 <code>VNode</code> 后，我们需要将其挂载到真实的 <code>DOM</code> 上。</p> <ul><li><p>首先根据 <code>tag</code> 属性创建真实 <code>DOM</code> 节点，并将该信息添加到 <code>VNode</code> 中。因此，向 <code>VNode</code> 添加 <code>el</code> 属性表示该 <code>VNode</code> 对应的真实 <code>DOM</code> 节点；</p></li> <li><p>对于 <code>props</code> 属性，我们规定事件的键名为 <code>on</code> 加上首字母大写的事件名，如点击事件键名就是 <code>onClick</code>，其余非 <code>on</code> 开头的键名则为 <code>id</code> 之类的非事件 <code>attribute</code>；</p></li> <li><p>对于 <code>children</code> 属性，如果类型为字符串，则该 <code>VNode</code> 为文本节点；否则该 <code>VNode</code> 包含子节点，我们递归对子 <code>VNode</code> 进行挂载，由于此时创建的真实 <code>DOM</code> 节点还可能为文本节点，因此需要额外进行判断，当 <code>tag</code> 为空时创建文本节点，否则创建元素节点；</p></li> <li><p>最后只需将创建的 <code>DOM</code> 节点添加为容器的子节点。</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">else</span> vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el

    <span class="token comment">// props</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> value <span class="token operator">=</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// children</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">mount</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就成功通过 <code>mount</code> 方法将创建好的 <code>VNode</code> 挂载到指定容器上。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    <span class="token string">'div'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'The div was clicked.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>

<span class="token function">mount</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/zYdaMgy" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="更新-patch"><a href="#更新-patch" class="header-anchor">#</a> 更新 patch</h2> <p>当元素内容改变生成新的 <code>VNode</code> 时，为什么不直接调用 <code>mount</code> 方法将该 <code>VNode</code> 更新到 <code>container</code> 中呢？</p> <p>主要是因为此时 <code>container</code> 中已经包含旧的 <code>VNode</code> 中的内容，通过比较两个 <code>VNode</code> 显然要比比较 <code>VNode</code> 和 <code>DOM</code> 元素要简单。我们通过比较两个 <code>VNode</code> 对象，只需将其中的不同之处更新到 <code>container</code> 中即可。</p> <p>因此，接下来我们就来实现 <code>patch</code> 方法，也就是我们常说的 <strong><code>diff</code></strong> 算法，对新、旧 <code>VNode</code> 进行比较并更新 <code>container</code>。</p> <p>对于两个不同的 <code>VNode</code>，我们首先判断它们是否同为文本节点，对于文本节点只需更新真实 <code>DOM</code> 元素的 <code>textContent</code> 属性值；其次比较它们的标签名 <code>tag</code>，如果 <code>tag</code> 都不相同，显然就没有必要再对其进行比较，直接将旧 <code>VNode</code> 移除，新 <code>VNode</code> 添加进 <code>container</code> 即可。</p> <p>当两者为相同的 <code>HTML</code> 元素，则需要比较其中的 <code>props</code> 和 <code>children</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isUndef</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> s <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">===</span> oldVnode<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 文本节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对 props 和 children 进一步比较</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> el<span class="token punctuation">.</span>parentNode
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对 <code>VNode</code> 的 <code>props</code> 更新比较简单，我们只需遍历所有新 <code>VNode</code> <code>props</code> 的键名，当该键名也存在于旧 <code>VNode</code> <code>props</code> 中，就对该 <code>attribute</code> 进行替换，不存在就新增，同时删除旧 <code>VNode</code> <code>props</code> 中多余的<code>attribute</code>。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">===</span> oldVnode<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// 文本节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// props</span>
        <span class="token keyword">const</span> oldProps <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">const</span> newProps <span class="token operator">=</span> vnode<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> oldValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> newValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
                    el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> el<span class="token punctuation">.</span>parentNode
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而对于 <code>VNode</code> 的子节点 <code>children</code> 进行更新则需要根据 <code>children</code> 的类型分情况讨论：</p> <ul><li><p>旧 <code>VNode</code> 子节点 <code>oldChildren</code> 为字符串，新 <code>VNode</code> 子节点 <code>newChildren</code> 也为字符串，两者都为文本节点，只需要替换真实 <code>DOM</code> 元素的 <code>textContent</code> 属性值即可；</p></li> <li><p><code>oldChildren</code> 为字符串，<code>newChildren</code> 为数组，则需将文本内容清空，并将 <code>newChildren</code> 中的子节点依次挂载到当前 <code>DOM</code> 元素；</p></li> <li><p><code>oldChildren</code> 为数组，<code>newChildren</code> 为字符串，仍然只需要替换 <code>textContent</code> 属性值即可；</p></li> <li><p><code>oldChildren</code> 为数组，<code>newChildren</code> 也为数组，此时新、旧 <code>VNode</code> 都包含多个子节点，子节点中又可能嵌套着更多的节点。因此，这时实际上我们是对两颗新、旧<strong>虚拟 <code>DOM</code> 树</strong>进行比较，这也是 <code>diff</code> 算法最核心的部分 —— <code>updateChildren</code>。为了容易理解，这里我们先简单地将 <code>oldChildren</code> 中所有子节点移除，<code>newChildren</code> 中所有子节点添加进当前 <code>DOM</code> 元素，下一节我们将对 <code>updateChildren</code> 算法进一步的优化。</p></li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">===</span> oldVnode<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// 文本节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// props</span>
        <span class="token keyword">const</span> oldProps <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">const</span> newProps <span class="token operator">=</span> vnode<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> oldValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> newValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
                    el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// children</span>
        <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children
        <span class="token keyword">const</span> newChildren <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> oldChildren <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChildren <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildren <span class="token operator">!==</span> oldChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newChildren
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
                newChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">mount</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChildren <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newChildren
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">updateChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> el<span class="token punctuation">.</span>parentNode
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>	<span class="token comment">// 移除子 VNode</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>	<span class="token comment">// 添加子 VNode</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就成功实现新、旧 <code>VNode</code> 的更新。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    <span class="token string">'div'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'green'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Old eventListener was removed.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token comment">// vnode 为前面挂载的节点</span>
<span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/NWvzQyM" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="diff-算法核心"><a href="#diff-算法核心" class="header-anchor">#</a> diff 算法核心</h2> <p>上一节的 <code>updateChildren</code> 算法对于子节点的更新显然不能满足我们的性能要求，它完全没有考虑节点复用的情况，需要频繁地删除、创建、添加 <code>DOM</code> 元素。实际上，新、旧 <code>VNode</code> 可能只是少数子元素改变。比如，下面例子中 <code>children</code> 只有一个子节点 <code>c</code> 更新为 <code>d</code>，如果将子节点全部删除，再重新创建、添加，无疑会造成不必要的性能消耗。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token comment">// oldChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">// newChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>因此，为减少性能开销，我们必须尽可能地对已有子节点进行复用。</p> <p>在基于只有少数子节点改变的假设下，我们的一个想法就是根据索引比较两个子节点 —— 对公共索引部分递归调用 <code>patch</code> 方法，旧的子节点多余的就直接移除，新的子节点剩下的就直接添加。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> commonLen <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldLen<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> commonLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLen <span class="token operator">&gt;</span> commonLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> commonLen<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newLen <span class="token operator">&gt;</span> commonLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> commonLen<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mount</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/Badgbgz" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>显然，从上述示例来看，这种思路是个不错的想法，子节点 <code>a b</code> 都得到了有效地复用。但是，在处理另外一些常见情况下，这种思路的性能将大大降低，比如当节点发生移动时。</p> <p>我们只是单纯地将所有子节点向左移动，子节点顺序发生改变。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token comment">// oldChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">// newChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>如果我们还是调用上面的 <code>updateChildren</code> 方法，按照索引对子节点进行 <code>patch</code> 更新。</p> <p><img src="/vue-design/assets/img/diff-1.1.dcaeb3a7.png" alt="diff-1.1"></p> <p>我们会发现，每个索引位置上的子节点都发生了改变，虽然示例中更新子节点只需要替换 <code>textContent</code>，但对于包含嵌套节点的子节点来说，毫无疑问大量子节点将被删除或者重新创建。因此，在应对节点移动、调换顺序这类问题上，根据索引比较子节点不是一个很好的方案。</p> <p>实际上，通过观察我们可以看到，由于各个子节点之间顺序发生调换，只要将节点 <code>a</code> 移动到节点 <code>c</code> 之后就完成了更新。</p> <p><img src="/vue-design/assets/img/diff-1.2.8c8732a8.png" alt="diff-1.2"></p> <h3 id="最大索引值比较"><a href="#最大索引值比较" class="header-anchor">#</a> 最大索引值比较</h3> <p>为了对尽可能多的子节点进行复用，我们为节点添加一个唯一标识 <code>key</code>，当新、旧子节点中出现 <code>key</code> 值相同的两个节点，就说明我们可以对这个旧的子节点进行复用，以此达到通过<strong>移动节点</strong>，而非删除、创建节点来更新 <code>children</code> 的目的。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token comment">// oldChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'b'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'c'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">// newChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'b'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'c'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>实际上，我们在 <code>Vue</code> 中使用 <code>v-for</code> 循环时为列表添加 <code>key</code> 也是这个目的。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in items<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{ item.message }}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样，我们就对 <code>VNode</code> 结构相应调整，除了 <code>tag el props children</code> 四个属性外，我们额外增加 <code>key</code> 属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> props <span class="token operator">?</span> props<span class="token punctuation">.</span>key <span class="token operator">:</span> <span class="token keyword">undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">)</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> tag<span class="token operator">:</span> tag<span class="token punctuation">,</span> props<span class="token operator">:</span> props<span class="token punctuation">,</span> children<span class="token operator">:</span> children<span class="token punctuation">,</span> key<span class="token operator">:</span> key <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么接下来只要遍历新、旧子节点，找到相同的 <code>key</code> 值的节点，就能到达节点复用的目的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">===</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token comment">// 移动节点</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么，再找到 <code>key</code> 值相同的节点后，应该如何对节点进行正确地移动呢？</p> <p>为此，我们记录下 <code>newChildren</code> 中节点在 <code>oldChildren</code> 中的<strong>索引</strong>，通过比较索引值的大小来说明当前节点是否需要移动。</p> <ul><li>当 <code>newChildren</code> 中节点索引为<strong>递增</strong>排序，说明新旧子节点顺序相同，不需要移动。</li></ul> <p>比如，下图中子节点 <code>a b c</code> 顺序没有改变，索引顺序为 <code>0 -&gt; 1 -&gt; 2</code>，呈递增趋势，所以子节点都不需要移动。</p> <p><img src="/vue-design/assets/img/diff-2.1.8dc89f46.png" alt="diff-2.1"></p> <ul><li>当 <code>newChildren</code> 中节点索引为<strong>非递增</strong>排序，说明新旧子节点顺序不同，需要移动。</li></ul> <p>比如，下图中子节点 <code>a b c</code> 顺序发生改变，索引顺序为 <code>1 -&gt; 2 -&gt; 0</code>，其中子节点 <code>b c</code> 索引大小递增，说明这两个新、旧子节点顺序相同，不需要移动；而子节点 <code>a</code> 的索引小于 <code>c</code> 的索引，说明应该将节点 <code>a</code> 对应的 <code>DOM</code> 元素移动到节点 <code>c</code> 对应的 <code>DOM</code> 元素之后。</p> <p><img src="/vue-design/assets/img/diff-2.2.2211de56.png" alt="diff-2.2"></p> <p>因此，我们在遍历 <code>children</code> 寻找 <code>key</code> 值相同的节点时，记录下 <code>key</code> 值相同节点在 <code>oldChildren</code> 中的<strong>最大值索引 <code>lastIndex</code></strong>。将 <code>lastIndex</code> 初始值设为 <code>-1</code>，这样当前索引值为 <code>0</code> 时 <code>lastIndex</code> 值也能正确更新。</p> <ul><li><p>如果当前 <code>newChildren</code> 节点在 <code>oldChildren</code> 索引值大于<strong>最大索引值</strong>，说明新、旧子节点顺序没有改变，无需移动节点顺序，只需更新最大索引值即可；</p></li> <li><p>否则新、旧子节点顺序发生改变，将当前节点对应的 <code>DOM</code> 元素移动到<strong>上一个节点</strong>对应的 <code>DOM</code> 元素之后。那么，为什么是将它移动到上一个节点而不是最大索引值节点对应的 <code>DOM</code> 元素之后呢？可以这样理解，我们从左向右遍历 <code>newChildren</code>，寻找 <code>key</code> 值相同的节点并移动 <code>DOM</code> 元素，当某一次节点移动完成后，该节点及其左边节点在 <code>newChildren</code> 中顺序和移动后的 <code>DOM</code> 元素顺序是一致的。</p></li></ul> <p>但是实际上我们还要考虑一种特殊情况，即子节点没有 <code>key</code> 值。我们一直在讨论的都是子节点有 <code>key</code> 值的情况下，由于 <code>key</code> 是唯一标识，在同一子节点中不会出现两个相同的 <code>key</code>。而子节点没有 <code>key</code> 值时，<code>newChildren</code> 的两个不同节点可能与 <code>oldChildren</code> 的同一个节点 <code>key</code> 值相同，因为它们 <code>key</code> 值都为 <code>undefined</code>。比如，下面示例中子节点 <code>b c a</code> 都匹配到 <code>oldChildren</code> 的第一个节点 <code>a</code>，它们都复用节点 <code>a</code> 显然会导致错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// oldChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">// newChildren</span>
<span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>因此，为避免没有 <code>key</code> 值的节点复用同一个旧子节点，我们可以在 <code>h</code> 函数返回 <code>VNode</code> 时，根据子节点所在索引为没有 <code>key</code> 值的节点手动添加唯一 <code>key</code> 值；或者利用布尔值记录某个旧子节点是否已经被复用。</p> <p>这里我们采用第二种方式，这样记录的布尔值在之后移除不存在的旧子节点也会用到。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length

    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment">// 最大索引值</span>
    <span class="token keyword">let</span> oldIdxMap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldIdxMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>   
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">===</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span> 
                <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 更新最大索引值</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 移动节点</span>
                    <span class="token keyword">const</span> node <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面的示例也能清楚地说明为什么是移动到<strong>上一个节点</strong>对应的 <code>DOM</code> 元素之后。<code>newChildren</code> 中节点索引顺序为 <code>2 -&gt; 1 -&gt; 0</code>。</p> <ul><li><p>当遍历到节点 <code>b</code>，当前索引值 <code>1</code> 小于最大索引值 <code>2</code>，则将 <code>DOM</code> 元素 <code>b</code> 移动到 <code>DOM</code> 元素 <code>c</code> 之后；</p></li> <li><p>当遍历到节点 <code>a</code>，当前索引值 <code>0</code> 小于最大索引值 <code>2</code>，则将 <code>DOM</code> 元素 <code>a</code> 移动到 <code>DOM</code> 元素 <code>b</code> 之后，而非最大索引值 <code>2</code> 对应的 <code>DOM</code> 元素 <code>c</code> 之后。</p></li></ul> <p><img src="/vue-design/assets/img/diff-2.3.5a0e6798.png" alt="diff-2.3"></p> <p>当然，不可能 <code>newChildren</code> 中的每个节点都能在 <code>oldChildren</code> 中找到 <code>key</code> 值相同的节点，因此，我们还需考虑两种情况就是 —— 添加新的节点以及移除不存在的节点。</p> <ul><li>如果 <code>oldChildren</code> 中查找不到当前相同 <code>key</code> 值的节点，则说明该节点是新添加的。我们用一个变量值 <code>find</code> 来说明 <code>oldChildren</code> 中是否存在相同 <code>key</code> 值的节点，当查找到时将该变量值设为 <code>true</code>，如果内层 <code>for</code> 循环结束 <code>find</code> 仍为 <code>false</code> 则表示该节点是新添加的。显然，该节点也是添加到<strong>上一个节点</strong>对应的 <code>DOM</code> 元素之后。当然，有一个特殊情况就是新添加的节点为 <code>newChildren</code> 的头节点，即该节点前面没有节点，那么我们就将这个新创建的 <code>DOM</code> 元素移动到 <code>children</code> 中所有 <code>DOM</code> 元素的前面。</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length

    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment">// 最大索引值</span>
    <span class="token keyword">let</span> oldIdxMap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldIdxMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>   
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> find <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">===</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                find <span class="token operator">=</span> <span class="token boolean">true</span>
                oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span> 
                <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 更新最大索引值</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 移动节点</span>
                    <span class="token keyword">const</span> node <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加新节点</span>
            <span class="token function">mount</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
            <span class="token keyword">const</span> node <span class="token operator">=</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling <span class="token operator">:</span> oldChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>比如，下图中节点 <code>d</code> 就是新添加的。</p> <p><img src="/vue-design/assets/img/diff-2.4.7f5e09f7.png" alt="diff-2.4"></p> <ul><li>当遍历完 <code>newChildren</code>，<code>oldChildren</code> 中仍然没有被匹配到的节点就是需要被移除的。我们对 <code>oldChildren</code> 再进行一次遍历，利用之前记录的布尔值数组 <code>oldIdxMap</code> 将不存在于 <code>newChildren</code> 的节点移除。</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length

    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment">// 最大索引值</span>
    <span class="token keyword">let</span> oldIdxMap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldIdxMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>   
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> find <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">===</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                find <span class="token operator">=</span> <span class="token boolean">true</span>
                oldIdxMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span> 
                <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 更新最大索引值</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 移动节点</span>
                    <span class="token keyword">const</span> node <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加新节点</span>
            <span class="token function">mount</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
            <span class="token keyword">const</span> node <span class="token operator">=</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling <span class="token operator">:</span> oldChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 移除不存在的节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldIdxMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>比如，下图中节点 <code>d</code> 就是需要被移除的。</p> <p><img src="/vue-design/assets/img/diff-2.5.2909ee0a.png" alt="diff-2.5"></p> <div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/mdBdxqL" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>以上也是 <code>React</code> <code>diff</code> 算法的原理。</p> <h3 id="双端比较"><a href="#双端比较" class="header-anchor">#</a> 双端比较</h3> <p>在上一小节的 <code>updateChildren</code> 算法中，我们对 <code>newChildren</code> 从左到右进行遍历，并记录下其中节点在 <code>oldChildren</code> 中的索引，通过比较索引大小来移动节点。</p> <p>这种方法确实充分地对子节点进行了复用，但是在某些情况下，算法中节点移动的次数可以进一步优化。</p> <p>我们先来看下面这个示例 —— <code>oldChildren</code> 节点顺序为 <code>a b c</code>，<code>newChildren</code> 节点顺序为 <code>c a b</code>。采用<strong>最大索引值比较</strong>的话，需要先将 <code>DOM</code> 元素 <code>a</code> 移动到 <code>DOM</code> 元素 <code>c</code> 之后，再将 <code>DOM</code> 元素 <code>b</code> 移动到 <code>DOM</code> 元素 <code>a</code> 之后，共移动两次 <code>DOM</code> 元素。而通过观察我们可以看到，实际上只要将 <code>DOM</code> 元素 <code>c</code> 移动到 <code>DOM</code> 元素 <code>a</code> 之前，移动一次 <code>DOM</code> 元素就成功更新。</p> <p><img src="/vue-design/assets/img/diff-3.1.10cfaacd.png" alt="diff-3.1"></p> <p>造成这种情况的主要原因就是<strong>最大索引值比较</strong>只是<strong>单向遍历</strong> <code>children</code>，因此，这一小节我们采用另外一种<strong>双向遍历</strong>的思路 —— <strong>双端比较</strong>，从新、旧子节点的左右两端开始比较。我们将指针分别指向新、旧子节点的头部和尾部。</p> <ul><li><p>首先比较 <code>children</code> 头节点 <code>newStartVnode</code> 与 <code>oldStartVnode</code> 的 <code>key</code> 值是否相同，相同则复用节点并将头部的两个指针指向下一个节点，否则进行下一次比较；</p></li> <li><p>比较 <code>children</code> 尾节点 <code>newEndVnode</code> 与 <code>oldEndVnode</code> 的 <code>key</code> 值是否相同，相同则复用节点并将尾部的两个指针指向上一个节点，否则进行下一次比较；</p></li> <li><p>比较 <code>newChildren</code> 头节点 <code>newStartVnode</code> 和 <code>oldChildren</code> 尾节点 <code>oldEndVnode</code> 的 <code>key</code> 值是否相同，相同则复用节点并更新指针指向，否则进行下一次比较；</p></li> <li><p>比较 <code>newChildren</code> 尾节点 <code>newEndVnode</code> 和 <code>oldChildren</code> 头节点 <code>oldStartVnode</code> 的 <code>key</code> 值是否相同，相同则复用节点并更新指针指向。</p></li></ul> <p><img src="/vue-design/assets/img/diff-3.2.dfcb3d63.png" alt="diff-3.2"></p> <p>同时，上述第 <code>1</code> 和 <code>2</code> 次比较中，由于节点位置没有改变，都是同时处于 <code>children</code> 头部或尾部，因此不需要移动 <code>DOM</code> 元素。而第 <code>3</code> 和 <code>4</code> 次比较中，节点位置发生改变，由 <code>children</code> 头部移动到尾部或者 <code>children</code> 尾部移动到头部，因此这时我们也需要移动对应的 <code>DOM</code> 元素。</p> <ul><li><p>当 <code>newStartVnode</code> 和 <code>oldEndVnode</code> <code>key</code> 值相同，则将 <code>oldEndVnode</code> 对应的 <code>DOM</code> 元素移动到当前 <code>children</code> 的最前面；</p></li> <li><p>当 <code>newEndVnode</code> 和 <code>oldStartVnode</code> <code>key</code> 值相同，则将 <code>oldStartVnode</code> 对应的 <code>DOM</code> 元素移动到当前 <code>children</code> 的最后面。</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> oldChildren<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> 

    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span>
            oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span>
            oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span>
            <span class="token comment">// 移动节点</span>
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span>
            <span class="token comment">// 移动节点</span>
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>
            oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newEndVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 头部或尾部没有找到 key 相同的节点</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们就用上面的示例来说明一下<strong>理想情况</strong>下的比较过程，即总能通过四次头、尾部节点的比较找到相同 <code>key</code> 值的元素。</p> <ul><li>第一轮比较中，<code>newChildren</code> 尾节点 <code>newEndVnode</code> 与 <code>oldChildren</code> 头节点 <code>oldStartVnode</code> 的 <code>key</code> 值相同，将 <code>DOM</code> 元素 <code>a</code> 移动到 <code>a b d c</code> 的尾部，并将 <code>newEndIdx</code> 指针前移，<code>oldStartIdx</code> 指针后移；</li></ul> <p><img src="/vue-design/assets/img/diff-3.3.c3e4060e.png" alt="diff-3.3"></p> <ul><li>第二轮比较中，<code>children</code> 头节点 <code>newStartVnode</code> 与 <code>oldStartVnode</code> 的 <code>key</code> 值相同，无需移动节点，只要将 <code>newStartIdx</code> 与 <code>oldStartIdx</code> 指针同时后移；</li></ul> <p><img src="/vue-design/assets/img/diff-3.4.e385e79f.png" alt="diff-3.4"></p> <ul><li>第三轮比较中，<code>newChildren</code> 头节点 <code>newStartVnode</code> 与 <code>oldChildren</code> 尾节点 <code>oldEndVnode</code> 的 <code>key</code> 值相同，将 <code>DOM</code> 元素 <code>c</code> 移动到 <code>d c</code> 的头部，并将 <code>newStartIdx</code> 指针后移，<code>oldEndIdx</code> 指针前移；</li></ul> <p><img src="/vue-design/assets/img/diff-3.5.5bd03559.png" alt="diff-3.5"></p> <ul><li>第四轮比较中，此时 <code>newChildren</code> 与 <code>oldChildren</code> 都只剩下一个节点 <code>d</code>，它们 <code>key</code> 值相同，无需移动节点，只要将 <code>newStartIdx</code> 与 <code>oldStartIdx</code> 指针同时后移。</li></ul> <p><img src="/vue-design/assets/img/diff-3.6.2e3705f3.png" alt="diff-3.6"></p> <p>此时，<code>oldStartIdx &gt; oldEndIdx</code>，循环条件不满足，退出循环，双端比较结束。</p> <p>但是显然，这只是理想情况，实际更新过程中肯定会出现四次比较后仍然没有出现匹配的情况。</p> <p>比如下图中，四次比较都没能找到 <code>key</code> 值相同的元素。</p> <p><img src="/vue-design/assets/img/diff-3.7.02946b28.png" alt="diff-3.7"></p> <p>对于这种非理想情况，我们应该如何处理呢？</p> <p>和最开始查找相同 <code>key</code> 值节点的方式一样，我们遍历 <code>oldChildren</code>，从中找到与 <code>newStartVnode</code> <code>key</code> 值相同的节点。</p> <ul><li><p>如果找到该节点，则对该节点进行复用，将该节点对应的 <code>DOM</code> 元素移动到当前 <code>children</code> 的头部。同时，由于没有指针指向该节点，我们无法通过移动 <code>oldStartIdx</code> 或 <code>oldEndIdx</code> 来更新 <code>oldChildren</code> 剩余节点，因此我们将该节点置为 <code>null</code>，当 <code>oldStartIdx</code> 或 <code>oldEndIdx</code> 对应节点为 <code>null</code> 时直接向后或向前移动指针；</p></li> <li><p>否则就说明 <code>newStartVnode</code> 为新添加的节点，我们创建新的 <code>DOM</code> 元素添加到当前 <code>children</code> 的头部。</p></li></ul> <p>这里我们使用对象存放 <code>oldChildren</code> 中 <code>key</code> 与索引之间的键值对便于多次查找，当然也可以使用 <code>findIndex</code> 等其它方法查找与 <code>newStartVnode</code> <code>key</code> 值相同的节点。</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">let</span> oldKeyToIdx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldKeyToIdx<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 头部或尾部没有找到 key 相同的节点</span>
        <span class="token keyword">const</span> indexInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>indexInOld<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mount</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            elemToMove <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>indexInOld<span class="token punctuation">]</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>elemToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span>
            oldChildren<span class="token punctuation">[</span>indexInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>elemToMove<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，在<strong>最大索引值比较</strong>中，我们提到子节点没有 <code>key</code> 值的情况，因此我们也需要讨论当子节点没有 <code>key</code> 值<strong>双端比较</strong>能否正确更新，避免出现多次复用同一个旧子节点的情况。</p> <ul><li><p>当 <code>newChildren</code> 中没有 <code>key</code> 值的节点匹配到 <code>oldChildren</code> 头部或尾部没有 <code>key</code> 值的节点，节点复用后指针发生移动，因此不会出现该旧子节点被再次复用的情况；</p></li> <li><p>当头部或尾部没有匹配到时，这个新子节点会被挂载并添加到当前 <code>children</code> 的头部。</p></li></ul> <p>显然，对于没有 <code>key</code> 值的子节点<strong>双端比较</strong>也能正确更新。当然和之前一样，当 <code>while</code> 循环结束时，<code>newChildren</code> 或 <code>oldChildren</code> 中可能还存在节点，这些节点是新添加的或者需要被移除的。</p> <ul><li><p>如果 <code>oldStartIdx &gt; oldEndIdx</code>，<code>newChildren</code> 中可能仍存在需要添加的节点，这些节点索引在 <code>newStartIdx</code> 与 <code>newEndIdx</code> 之间。我们将其逐个挂载，由于剩余节点可能在初始 <code>newChildren</code> 的头部、中间也可能是尾部，那么应该这些新创建的节点添加到哪个位置呢？其实和之前<strong>最大索引值比较</strong>时插入到<strong>上一个节点</strong>对应的 <code>DOM</code> 元素之后一样，因为除了这些需要添加的节点，<code>newChildren</code> 中其它节点都已经更新成功，我们只需将这些节点对应的 <code>DOM</code> 元素插入到 <strong><code>newStartIdx</code> 上一个节点</strong>对应的 <code>DOM</code> 元素之后、或者 <strong><code>newEndIdx</code> 下一个节点</strong>对应的 <code>DOM</code> 元素之前即可，当然也需要考虑超出 <code>newChildren</code> 索引范围的边界情况；</p></li> <li><p>如果 <code>newStartIdx &gt; newEndIdx</code>，<code>oldChildren</code> 中可能仍存在需要移除的节点，这些节点索引在 <code>oldStartIdx</code> 与 <code>oldEndIdx</code> 之间。相比于添加新的节点，移除旧的节点就比较简单，我们只需使用 <code>removeChild</code> 方法将这些节点对应的 <code>DOM</code> 元素逐个移除即可。</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加新节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> <span class="token operator">++</span>newStartIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newStartVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newChildren<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 移除不存在的节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> <span class="token operator">++</span>oldStartIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span>
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Tip</p> <p><a href="https://codepen.io/yangzheli/pen/yLzLKLr" target="_blank" rel="noopener noreferrer">在 CodePen 上尝试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>以上也是 <code>Snabbdom</code> 和 <code>Vue2</code> <code>diff</code> 的原理。</p> <h2 id="dom-api-封装"><a href="#dom-api-封装" class="header-anchor">#</a> DOM API 封装</h2> <p>在前面小节我们提到过，为实现<strong>跨平台</strong>，我们可以对不同平台的编程接口进行封装。由于我们渲染最多的就是 <code>DOM</code> 元素，因此这里以 <code>DOM</code> 编程接口封装为例说明如何封装相关的 <code>API</code>。</p> <p>其实封装起来也比较简单，我们将 <code>createElement</code> 等需要用到的 <code>DOM</code> 方法全都封装进变量 <code>htmlDomApi</code> 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> referenceNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 其它 DOM API</span>

<span class="token keyword">const</span> htmlDomApi <span class="token operator">=</span> <span class="token punctuation">{</span>
    createElement<span class="token punctuation">,</span>
    insertBefore<span class="token punctuation">,</span>
    <span class="token comment">// 其它 DOM API</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们可以在初始化时将不同平台的编程接口 <code>domApi</code> 作为参数传入，默认情况下就是使用 <code>DOM</code> 编程接口 <code>htmlDomApi</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> api <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi

<span class="token comment">// 创建元素</span>
api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yangzheli/vue-design/edit/master/zh/2-render-function.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue-design/zh/1-reactivity.html" class="prev">
        响应性
      </a></span> <span class="next"><a href="/vue-design/zh/3-mini-vue.html">
        迷你 Vue 实现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vue-design/assets/js/app.b406f0e2.js" defer></script><script src="/vue-design/assets/js/2.19e19e46.js" defer></script><script src="/vue-design/assets/js/3.77b9243c.js" defer></script>
  </body>
</html>
